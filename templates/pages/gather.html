{{define "gather"}}
{{template "base" .}}
{{end}}

{{define "main"}}
<div class="gather-page">
    <div class="gather-header">
        <div class="gather-header-content">
            <div class="gather-title">
                <h1>Gather</h1>
                <p>Discover and create meaningful connections through local events and gatherings.</p>
            </div>
            <div class="gather-actions">
                <button class="btn-primary" hx-get="/gather/new" hx-target="#modal">Create Event</button>
                <button class="btn-secondary" hx-get="/gather/search" hx-target="#modal">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"></path></svg>
                    Search Events
                </button>
            </div>
        </div>
        
        <div class="gather-filters">
            <div class="filter-categories">
                {{range .EventCategories}}
                <button class="category-filter" data-category="{{.ID}}">
                    <span class="category-icon">{{.Icon}}</span>
                    <span class="category-name">{{.Name}}</span>
                    <span class="category-count">{{.Count}}</span>
                </button>
                {{end}}
            </div>
        </div>
    </div>

    <div class="gather-content">
        {{if .FeaturedEvents}}
        <section class="featured-events">
            <div class="section-header">
                <h2>Featured Events</h2>
                <button class="see-all-btn" hx-get="/gather/featured" hx-target="#main-content">See All</button>
            </div>
            <div class="featured-events-grid">
                {{range .FeaturedEvents}}
                {{template "event-card-featured" .}}
                {{end}}
            </div>
        </section>
        {{end}}

        <div class="gather-main">
            <div class="events-list">
                <section class="upcoming-events">
                    <div class="section-header">
                        <h2>Upcoming Events</h2>
                        <div class="view-controls">
                            <button class="view-btn active" data-view="list">List</button>
                            <button class="view-btn" data-view="grid">Grid</button>
                        </div>
                    </div>
                    <div class="events-container" data-view="list">
                        {{range .UpcomingEvents}}
                        {{template "event-card-list" .}}
                        {{end}}
                    </div>
                    <div class="load-more-container">
                        <button class="btn-secondary" hx-get="/api/gather/more" hx-target=".events-container" hx-swap="beforeend">
                            Load More Events
                        </button>
                    </div>
                </section>

                {{if .MyEvents}}
                <section class="my-events">
                    <div class="section-header">
                        <h2>My Events</h2>
                        <button class="see-all-btn" hx-get="/gather/manage" hx-target="#modal">Manage</button>
                    </div>
                    <div class="my-events-list">
                        {{range .MyEvents}}
                        {{template "event-card-compact" .}}
                        {{end}}
                    </div>
                </section>
                {{end}}
            </div>

            <div class="gather-sidebar">
                <div class="sidebar-section">
                    <h3>Popular Locations</h3>
                    <div class="location-list">
                        {{range .PopularLocations}}
                        <button class="location-item" hx-get="/gather/location/{{.Name}}" hx-target="#main-content">
                            <div class="location-info">
                                <span class="location-name">{{.Name}}</span>
                                {{if .City}}<span class="location-city">{{.City}}</span>{{end}}
                            </div>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9,18 15,12 9,6"/>
                            </svg>
                        </button>
                        {{end}}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modal" hx-swap-oob="true"></div>
{{end}}

{{define "event-card-featured"}}
<div class="event-card featured" hx-get="/gather/event/{{.ID}}" hx-target="#modal">
    {{if .Image}}
    <div class="event-image">
        <img src="{{.Image.URL}}" alt="{{.Image.Alt}}" loading="lazy">
        <div class="event-type-badge {{.Type}}">{{.Type}}</div>
        {{if .IsTicketed}}
        <div class="ticket-badge">{{.Currency}} {{.Price}}</div>
        {{end}}
    </div>
    {{end}}
    <div class="event-content">
        <div class="event-meta">
            <span class="event-category">{{.Category}}</span>
            {{if .Circle}}<span class="event-circle">{{.Circle}}</span>{{end}}
            <span class="event-time">{{.TimeAgo}}</span>
        </div>
        <h3 class="event-title">{{.Title}}</h3>
        <p class="event-description">{{.Description}}</p>
        <div class="event-details">
            <div class="event-host">
                <img src="{{.Host.Avatar}}" alt="{{.Host.Name}}" class="host-avatar">
                <span class="host-name">{{.Host.Name}}</span>
            </div>
            <div class="event-location">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                    <circle cx="12" cy="10" r="3"/>
                </svg>
                <span>{{.Location.Name}}</span>
            </div>
        </div>
        <div class="event-stats">
            <span class="attendee-count">{{.AttendeeCount}}/{{.Capacity}} attending</span>
            <div class="event-tags">
                {{range .Tags}}
                <span class="tag">{{.}}</span>
                {{end}}
            </div>
        </div>
    </div>
</div>
{{end}}

{{define "event-card-list"}}
<div class="event-card list {{.RSVPStatus}}" hx-get="/gather/event/{{.ID}}" hx-target="#modal">
    <div class="event-card-content">
        {{if .Image}}
        <div class="event-thumbnail">
            <img src="{{.Image.URL}}" alt="{{.Image.Alt}}" loading="lazy">
            <div class="event-type-indicator {{.Type}}"></div>
        </div>
        {{end}}
        <div class="event-info">
            <div class="event-header">
                <h3 class="event-title">{{.Title}}</h3>
                <div class="event-meta">
                    <span class="event-category">{{.Category}}</span>
                    {{if .Circle}}<span class="event-circle">{{.Circle}}</span>{{end}}
                </div>
            </div>
            <p class="event-description">{{.Description}}</p>
            <div class="event-details">
                <div class="detail-item">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12,6 12,12 16,14"/>
                    </svg>
                    <span>{{.TimeAgo}} • {{.Duration}}</span>
                </div>
                <div class="detail-item">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                        <circle cx="12" cy="10" r="3"/>
                    </svg>
                    <span>{{.Location.Name}}{{if .Location.City}}, {{.Location.City}}{{end}}</span>
                </div>
            </div>
        </div>
    </div>
    <div class="event-actions">
        <div class="rsvp-status {{.RSVPStatus}}">
            {{if eq .RSVPStatus "going"}}✓ Going{{else if eq .RSVPStatus "maybe"}}? Maybe{{else if eq .RSVPStatus "not_going"}}✗ Not Going{{else}}RSVP{{end}}
        </div>
        {{if .IsTicketed}}
        <div class="ticket-price">{{.Currency}} {{.Price}}</div>
        {{end}}
        <div class="attendee-info">{{.AttendeeCount}}/{{.Capacity}}</div>
    </div>
</div>
{{end}}

{{define "event-card-compact"}}
<div class="event-card compact {{.RSVPStatus}}" hx-get="/gather/event/{{.ID}}" hx-target="#modal">
    <div class="event-basic-info">
        <h4 class="event-title">{{.Title}}</h4>
        <div class="event-meta">
            <span class="event-time">{{.TimeAgo}}</span>
            {{if .IsHost}}<span class="host-badge">Host</span>{{end}}
        </div>
    </div>
    <div class="event-quick-stats">
        <span class="attendee-count">{{.AttendeeCount}} attending</span>
        {{if .Announcements}}
        <div class="announcement-indicator" title="{{len .Announcements}} new announcements">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
            </svg>
            <span>{{len .Announcements}}</span>
        </div>
        {{end}}
    </div>
</div>
{{end}}

{{define "scripts"}}
<script>
// Gather page functionality
document.addEventListener('DOMContentLoaded', function() {
    // Category filter functionality
    const categoryFilters = document.querySelectorAll('.category-filter');
    categoryFilters.forEach(filter => {
        filter.addEventListener('click', function() {
            const category = this.dataset.category;
            const activeCategory = document.querySelector('.category-filter.active');
            
            if (activeCategory && activeCategory.dataset.category === category) {
                activeCategory.classList.remove('active')
                console.log('Removing filter:', category);
                return;
            }
            
            // Update active state
            categoryFilters.forEach(f => f.classList.remove('active'));
            this.classList.add('active');
            
            // Filter events (could be enhanced with HTMX)
            console.log('Filtering by category:', category);
        });
    });
    
    // View toggle functionality
    const viewButtons = document.querySelectorAll('.view-btn');
    const eventsContainer = document.querySelector('.events-container');
    
    viewButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const view = this.dataset.view;
            
            // Update active state
            viewButtons.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Update container view
            if (eventsContainer) {
                eventsContainer.setAttribute('data-view', view);
            }
        });
    });
});

// HTMX event handling
document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.detail.target.id === 'modal') {
        // Modal opened - could add modal-specific initialization
        console.log('Event modal opened');
    }
});
</script>
{{end}}