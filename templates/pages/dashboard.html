{{define "dashboard"}}
{{template "base" .}}
{{end}}

{{define "main"}}
<div class="dashboard">
    <aside class="left-sidebar">
        <div class="quick-actions-vertical">
            <button class="action-btn-vertical primary" hx-get="/posts/new" hx-target="#modal">New Post</button>
            <button class="action-btn-vertical" hx-get="/messages/new" hx-target="#modal">Direct Message</button>
            <button class="action-btn-vertical" hx-get="/gatherings/new" hx-target="#modal">Create Gathering</button>
        </div>
        
        {{template "circles-sidebar" .}}
        
        <div class="sidebar-section">
            <h3>Stewardship</h3>
            <div class="impact-stats">
                {{range .Impact}}
                <div class="impact-item">
                    <span class="impact-label">{{.Label}}</span>
                    <span class="impact-value">{{.Value}}</span>
                </div>
                {{end}}
            </div>
            <button class="sidebar-action-btn" hx-get="/stewardship/manage" hx-target="#modal">Manage Stewardship</button>
        </div>
    </aside>

    <div class="main-content" id="main-content">
        <section class="feed-section">
            <h2>Recent Activity</h2>
            <div class="activity-feed" id="activity-feed">
                {{range .Feed}}
                {{template "feed-item" .}}
                {{end}}
            </div>
            <div class="load-more-container" style="text-align: center; margin-top: 1rem;">
                <button class="feed-more-btn" hx-get="/api/feed/more?offset={{.FeedOffset}}" hx-target="#activity-feed" hx-swap="beforeend">
                    Load More Posts
                </button>
            </div>
        </section>

        <section class="discussions-section">
            <h2>Active Discussions</h2>
            <div class="discussion-list">
                {{range .Discussions}}
                <div class="discussion-item" hx-get="/discussions/{{.ID}}" hx-target="#main-content">
                    <div class="discussion-header">
                        <h3 class="discussion-title">{{.Title}}</h3>
                        <div class="discussion-meta">
                            <span class="discussion-circle">{{.Circle}}</span>
                            <span>{{.TimeAgo}}</span>
                        </div>
                    </div>
                    <p class="discussion-preview">{{.Preview}}</p>
                    <div class="discussion-actions">
                        <button class="discussion-action" hx-get="/discussions/{{.ID}}" hx-target="#main-content">Join Discussion</button>
                    </div>
                </div>
                {{end}}
            </div>
            <button class="see-all-btn" hx-get="/discussions" hx-target="#main-content">Browse All Discussions</button>
        </section>
    </div>

    <div class="right-sidebar">        
        <div class="sidebar-section">
            <h3>
                <svg width="1.5rem" height="1.5rem" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="14" cy="14" r="5" stroke="currentColor" stroke-opacity="0.6" stroke-width="2"/>
                    <circle cx="14" cy="14" r="2" fill="currentColor"/>
                    <circle cx="14" cy="14" r="9" stroke="currentColor" stroke-opacity="0.3" stroke-width="2"/>
                    <circle cx="14" cy="14" r="13" stroke="currentColor" stroke-opacity="0.08" stroke-width="2"/>
                </svg>
                Recent Ripples
            </h3>
            <div class="ripples-compact">
                {{range .Ripples}}
                <div class="ripple-compact" hx-get="/ripples/{{.ID}}" hx-target="#modal">
                    <div class="ripple-user-compact">{{.User}}</div>
                    <div class="ripple-content-compact">{{.Content}}</div>
                    <div class="ripple-expires-compact">{{.ExpiresIn}}</div>
                </div>
                {{end}}
            </div>
            <button class="sidebar-action-btn" hx-get="/ripples/new" hx-target="#modal">New Ripple</button>
        </div>

        {{template "events-sidebar" .}}

        {{template "marketplace-sidebar" .}}
    </div>
</div>

<!-- Modal container for HTMX -->
<div id="modal" hx-swap-oob="true"></div>
{{end}}

{{define "scripts"}}
<script>
// Theme Manager Implementation
class ThemeManager {
    constructor() {
        this.themeButton = document.querySelector('.theme-menu');
        this.dropdown = document.querySelector('.theme-dropdown');
        this.radiusOptions = document.querySelectorAll('.radius-option');
        this.themeOptions = document.querySelectorAll('.theme-option');
        this.root = document.documentElement;
        
        this.init();
    }
    
    init() {
        this.loadPreferences();
        
        this.themeButton.addEventListener('click', (e) => {
            e.stopPropagation();
            this.toggleDropdown();
        });
        
        this.radiusOptions.forEach(option => {
            option.addEventListener('click', () => {
                const radius = option.dataset.radius;
                this.setRadius(radius);
            });
        });
        
        this.themeOptions.forEach(option => {
            option.addEventListener('click', () => {
                const theme = option.dataset.theme;
                this.setTheme(theme);
            });
        });
        
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.theme-menu-container')) {
                this.closeDropdown();
            }
        });
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !this.dropdown.hidden) {
                this.closeDropdown();
                this.themeButton.focus();
            }
        });
    }
    
    toggleDropdown() {
        if (this.dropdown.hidden) {
            this.openDropdown();
        } else {
            this.closeDropdown();
        }
    }
    
    openDropdown() {
        this.dropdown.hidden = false;
        this.themeButton.setAttribute('aria-expanded', 'true');
    }
    
    closeDropdown() {
        this.dropdown.hidden = true;
        this.themeButton.setAttribute('aria-expanded', 'false');
    }
    
    setRadius(radius) {
        this.root.style.setProperty('--container-radius', radius + 'px');
        
        this.radiusOptions.forEach(option => {
            option.classList.toggle('active', option.dataset.radius === radius);
        });
        
        localStorage.setItem('theme-radius', radius);
        
        // Save to server
        fetch('/api/theme/radius', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ radius: parseInt(radius) })
        });
    }
    
    setTheme(theme) {
        document.body.classList.remove('theme-light', 'theme-dark', 'theme-system');
        document.body.classList.add(`theme-${theme}`);
        
        if (theme === 'light') {
            this.applyLightTheme();
        } else if (theme === 'dark') {
            this.applyDarkTheme();
        } else {
            this.applySystemTheme();
        }
        
        this.themeOptions.forEach(option => {
            option.classList.toggle('active', option.dataset.theme === theme);
        });
        
        localStorage.setItem('theme-mode', theme);
        
        // Save to server
        fetch('/api/theme/mode', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mode: theme })
        });
    }
    
    applyLightTheme() {
        this.root.style.setProperty('--bg-primary', '#ffffff');
        this.root.style.setProperty('--bg-secondary', '#f5f5f5');
        this.root.style.setProperty('--bg-tertiary', '#f9f9f9');
        this.root.style.setProperty('--text-primary', '#000000');
        this.root.style.setProperty('--text-secondary', '#666666');
        this.root.style.setProperty('--text-tertiary', '#999999');
        this.root.style.setProperty('--border-primary', '#000000');
        this.root.style.setProperty('--border-secondary', '#cccccc');
        this.root.style.setProperty('--border-light', '#eeeeee');
        this.root.style.setProperty('--accent-primary', '#000000');
        this.root.style.setProperty('--accent-secondary', '#ffffff');
        this.root.style.setProperty('--hover-bg', '#f5f5f5');
        this.root.style.setProperty('--active-bg', '#000000');
        this.root.style.setProperty('--active-text', '#ffffff');
        this.root.style.setProperty('--shadow-color', 'rgba(0, 0, 0, 0.1)');
    }
    
    applyDarkTheme() {
        this.root.style.setProperty('--bg-primary', '#000000');
        this.root.style.setProperty('--bg-secondary', '#0a0a0a');
        this.root.style.setProperty('--bg-tertiary', '#111111');
        this.root.style.setProperty('--text-primary', '#ffffff');
        this.root.style.setProperty('--text-secondary', '#a3a3a3');
        this.root.style.setProperty('--text-tertiary', '#666666');
        this.root.style.setProperty('--border-primary', '#ffffff');
        this.root.style.setProperty('--border-secondary', '#333333');
        this.root.style.setProperty('--border-light', '#222222');
        this.root.style.setProperty('--accent-primary', '#ffffff');
        this.root.style.setProperty('--accent-secondary', '#000000');
        this.root.style.setProperty('--hover-bg', '#1a1a1a');
        this.root.style.setProperty('--active-bg', '#ffffff');
        this.root.style.setProperty('--active-text', '#000000');
        this.root.style.setProperty('--shadow-color', 'rgba(255, 255, 255, 0.1)');
    }
    
    applySystemTheme() {
        const properties = [
            '--bg-primary', '--bg-secondary', '--bg-tertiary',
            '--text-primary', '--text-secondary', '--text-tertiary',
            '--border-primary', '--border-secondary', '--border-light',
            '--accent-primary', '--accent-secondary',
            '--hover-bg', '--active-bg', '--active-text', '--shadow-color'
        ];
        
        properties.forEach(prop => {
            this.root.style.removeProperty(prop);
        });
    }
    
    loadPreferences() {
        const savedRadius = localStorage.getItem('theme-radius') || '{{.Theme.Radius}}';
        this.setRadius(savedRadius);
        
        const savedTheme = localStorage.getItem('theme-mode') || '{{.Theme.Mode}}';
        this.setTheme(savedTheme);
    }
}

// Initialize theme manager when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    new ThemeManager();
});

// HTMX event listeners for dynamic content
document.body.addEventListener('htmx:afterSwap', function(evt) {
    // Re-initialize any JavaScript components in dynamically loaded content
    if (evt.detail.target.id === 'main-content') {
        // Reinitialize any components that might be in the new content
        console.log('Content swapped in main area');
    }
});

// Handle theme switching via HTMX
document.body.addEventListener('htmx:responseError', function(evt) {
    console.error('HTMX Error:', evt.detail.xhr.responseText);
});
</script>
{{end}}