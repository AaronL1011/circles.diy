{{define "dashboard"}}
{{template "base" .}}
{{end}}

{{define "main"}}
<div class="dashboard">
    <div class="left-sidebar">
        {{template "circles-sidebar" .}}
        
        <aside class="sidebar-section">
            <h3>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24ZM74.08,197.5a64,64,0,0,1,107.84,0,87.83,87.83,0,0,1-107.84,0ZM96,120a32,32,0,1,1,32,32A32,32,0,0,1,96,120Zm97.76,66.41a79.66,79.66,0,0,0-36.06-28.75,48,48,0,1,0-59.4,0,79.66,79.66,0,0,0-36.06,28.75,88,88,0,1,1,131.52,0Z"></path></svg>
                My Impact
            </h3>
            <div class="impact-stats">
                {{range .Impact}}
                <div class="impact-item">
                    <span class="impact-label">{{.Label}}</span>
                    <span class="impact-value">{{.Value}}</span>
                </div>
                {{end}}
            </div>
            <button class="sidebar-action-btn" hx-get="/impact/full" hx-target="#modal">View Detailed Impact</button>
        </aside>
    </div>

    <div class="main-content" id="main-content">
        <section class="feed-section">
            <h2>Activity Feed</h2>
            <div class="activity-feed" id="activity-feed">
                {{range .Feed}}
                {{template "feed-item" .}}
                {{end}}
            </div>
            <div class="load-more-container" style="text-align: center; margin-top: 1rem;">
                <button class="sidebar-action-btn" hx-get="/api/feed/more?offset={{.FeedOffset}}" hx-target="#activity-feed" hx-swap="beforeend">
                    Load More Posts
                </button>
            </div>
        </section>

        <section class="discussions-section">
            <h2>Recent Discussions</h2>
            <div class="discussion-list">
                {{range .Discussions}}
                <div class="discussion-item" hx-get="/discussions/{{.ID}}" hx-target="#main-content">
                    <div class="discussion-header">
                        <div class="discussion-title">{{.Title}}</div>
                        <div class="discussion-meta">
                            <span class="discussion-circle">{{.Circle}}</span>
                            <span>{{.TimeAgo}}</span>
                        </div>
                    </div>
                    <div class="discussion-preview">{{.Preview}}</div>
                    <div class="discussion-actions">
                        <button class="discussion-action" hx-get="/discussions/{{.ID}}" hx-target="#main-content">Join Discussion</button>
                    </div>
                </div>
                {{end}}
            </div>
            <button class="see-all-btn" hx-get="/discussions" hx-target="#main-content">See All Discussions</button>
        </section>
    </div>

    <div class="right-sidebar">
        {{template "events-sidebar" .}}
        
        <aside class="sidebar-section">
            <h3>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><circle cx="128" cy="128" r="96" fill="none" stroke="currentColor" stroke-width="16"></circle><circle cx="128" cy="128" r="16" fill="currentColor"></circle><line x1="128" y1="32" x2="128" y2="48" stroke="currentColor" stroke-width="16"></line><line x1="128" y1="208" x2="128" y2="224" stroke="currentColor" stroke-width="16"></line><line x1="195.88" y1="60.12" x2="184.49" y2="71.51" stroke="currentColor" stroke-width="16"></line><line x1="71.51" y1="184.49" x2="60.12" y2="195.88" stroke="currentColor" stroke-width="16"></line><line x1="224" y1="128" x2="208" y2="128" stroke="currentColor" stroke-width="16"></line><line x1="48" y1="128" x2="32" y2="128" stroke="currentColor" stroke-width="16"></line><line x1="195.88" y1="195.88" x2="184.49" y2="184.49" stroke="currentColor" stroke-width="16"></line><line x1="71.51" y1="71.51" x2="60.12" y2="60.12" stroke="currentColor" stroke-width="16"></line></svg>
                Quick Ripples
            </h3>
            <div class="ripples-compact">
                {{range .Ripples}}
                <div class="ripple-compact" hx-get="/ripples/{{.ID}}" hx-target="#modal">
                    <div class="ripple-user-compact">{{.User}}</div>
                    <div class="ripple-content-compact">{{.Content}}</div>
                    <div class="ripple-expires-compact">expires {{.ExpiresIn}}</div>
                </div>
                {{end}}
            </div>
            <button class="sidebar-action-btn" hx-get="/ripples/create" hx-target="#modal">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 256 256"><path d="M224,128a8,8,0,0,1-8,8H136v80a8,8,0,0,1-16,0V136H40a8,8,0,0,1,0-16h80V40a8,8,0,0,1,16,0v80h80A8,8,0,0,1,224,128Z"></path></svg>
                Send Ripple
            </button>
        </aside>

        {{template "marketplace-sidebar" .}}
    </div>
</div>

<!-- Modal container for HTMX -->
<div id="modal" hx-swap-oob="true"></div>
{{end}}

{{define "scripts"}}
<script>
// Theme Manager Implementation
class ThemeManager {
    constructor() {
        this.themeButton = document.querySelector('.theme-menu');
        this.dropdown = document.querySelector('.theme-dropdown');
        this.radiusOptions = document.querySelectorAll('.radius-option');
        this.themeOptions = document.querySelectorAll('.theme-option');
        this.root = document.documentElement;
        
        this.init();
    }
    
    init() {
        this.loadPreferences();
        
        this.themeButton.addEventListener('click', (e) => {
            e.stopPropagation();
            this.toggleDropdown();
        });
        
        this.radiusOptions.forEach(option => {
            option.addEventListener('click', () => {
                const radius = option.dataset.radius;
                this.setRadius(radius);
            });
        });
        
        this.themeOptions.forEach(option => {
            option.addEventListener('click', () => {
                const theme = option.dataset.theme;
                this.setTheme(theme);
            });
        });
        
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.theme-menu-container')) {
                this.closeDropdown();
            }
        });
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !this.dropdown.hidden) {
                this.closeDropdown();
                this.themeButton.focus();
            }
        });
    }
    
    toggleDropdown() {
        if (this.dropdown.hidden) {
            this.openDropdown();
        } else {
            this.closeDropdown();
        }
    }
    
    openDropdown() {
        this.dropdown.hidden = false;
        this.themeButton.setAttribute('aria-expanded', 'true');
    }
    
    closeDropdown() {
        this.dropdown.hidden = true;
        this.themeButton.setAttribute('aria-expanded', 'false');
    }
    
    setRadius(radius) {
        this.root.style.setProperty('--container-radius', radius + 'px');
        
        this.radiusOptions.forEach(option => {
            option.classList.toggle('active', option.dataset.radius === radius);
        });
        
        localStorage.setItem('theme-radius', radius);
        
        // Save to server
        fetch('/api/theme/radius', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ radius: parseInt(radius) })
        });
    }
    
    setTheme(theme) {
        document.body.classList.remove('theme-light', 'theme-dark', 'theme-system');
        document.body.classList.add(`theme-${theme}`);
        
        if (theme === 'light') {
            this.applyLightTheme();
        } else if (theme === 'dark') {
            this.applyDarkTheme();
        } else {
            this.applySystemTheme();
        }
        
        this.themeOptions.forEach(option => {
            option.classList.toggle('active', option.dataset.theme === theme);
        });
        
        localStorage.setItem('theme-mode', theme);
        
        // Save to server
        fetch('/api/theme/mode', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mode: theme })
        });
    }
    
    applyLightTheme() {
        this.root.style.setProperty('--bg-primary', '#ffffff');
        this.root.style.setProperty('--bg-secondary', '#f5f5f5');
        this.root.style.setProperty('--bg-tertiary', '#f9f9f9');
        this.root.style.setProperty('--text-primary', '#000000');
        this.root.style.setProperty('--text-secondary', '#666666');
        this.root.style.setProperty('--text-tertiary', '#999999');
        this.root.style.setProperty('--border-primary', '#000000');
        this.root.style.setProperty('--border-secondary', '#cccccc');
        this.root.style.setProperty('--border-light', '#eeeeee');
        this.root.style.setProperty('--accent-primary', '#000000');
        this.root.style.setProperty('--accent-secondary', '#ffffff');
        this.root.style.setProperty('--hover-bg', '#f5f5f5');
        this.root.style.setProperty('--active-bg', '#000000');
        this.root.style.setProperty('--active-text', '#ffffff');
        this.root.style.setProperty('--shadow-color', 'rgba(0, 0, 0, 0.1)');
    }
    
    applyDarkTheme() {
        this.root.style.setProperty('--bg-primary', '#000000');
        this.root.style.setProperty('--bg-secondary', '#0a0a0a');
        this.root.style.setProperty('--bg-tertiary', '#111111');
        this.root.style.setProperty('--text-primary', '#ffffff');
        this.root.style.setProperty('--text-secondary', '#a3a3a3');
        this.root.style.setProperty('--text-tertiary', '#666666');
        this.root.style.setProperty('--border-primary', '#ffffff');
        this.root.style.setProperty('--border-secondary', '#333333');
        this.root.style.setProperty('--border-light', '#222222');
        this.root.style.setProperty('--accent-primary', '#ffffff');
        this.root.style.setProperty('--accent-secondary', '#000000');
        this.root.style.setProperty('--hover-bg', '#1a1a1a');
        this.root.style.setProperty('--active-bg', '#ffffff');
        this.root.style.setProperty('--active-text', '#000000');
        this.root.style.setProperty('--shadow-color', 'rgba(255, 255, 255, 0.1)');
    }
    
    applySystemTheme() {
        const properties = [
            '--bg-primary', '--bg-secondary', '--bg-tertiary',
            '--text-primary', '--text-secondary', '--text-tertiary',
            '--border-primary', '--border-secondary', '--border-light',
            '--accent-primary', '--accent-secondary',
            '--hover-bg', '--active-bg', '--active-text', '--shadow-color'
        ];
        
        properties.forEach(prop => {
            this.root.style.removeProperty(prop);
        });
    }
    
    loadPreferences() {
        const savedRadius = localStorage.getItem('theme-radius') || '{{.Theme.Radius}}';
        this.setRadius(savedRadius);
        
        const savedTheme = localStorage.getItem('theme-mode') || '{{.Theme.Mode}}';
        this.setTheme(savedTheme);
    }
}

// Initialize theme manager when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    new ThemeManager();
});

// HTMX event listeners for dynamic content
document.body.addEventListener('htmx:afterSwap', function(evt) {
    // Re-initialize any JavaScript components in dynamically loaded content
    if (evt.detail.target.id === 'main-content') {
        // Reinitialize any components that might be in the new content
        console.log('Content swapped in main area');
    }
});

// Handle theme switching via HTMX
document.body.addEventListener('htmx:responseError', function(evt) {
    console.error('HTMX Error:', evt.detail.xhr.responseText);
});
</script>
{{end}}