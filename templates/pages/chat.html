{{define "chat"}}
{{template "base" .}}
{{end}}

{{define "main"}}
<div class="chat-page">
    <div class="chat-container">
        <!-- Chat Sidebar -->
        <aside class="chat-sidebar">
            <div class="chat-sidebar-header">
                <h2>Conversations</h2>
                <div class="chat-actions">
                    <button class="new-chat-btn" hx-get="/chat/new" hx-target="#modal" aria-label="Start new conversation">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256">
                            <path d="M224,128a8,8,0,0,1-8,8H136v80a8,8,0,0,1-16,0V136H40a8,8,0,0,1,0-16h80V40a8,8,0,0,1,16,0v80h80A8,8,0,0,1,224,128Z"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="conversation-search">
                <input type="search" placeholder="Search conversations..." class="search-input" aria-label="Search conversations">
            </div>

            <div class="conversation-list">
                {{range .Conversations}}
                <div class="conversation-item {{if eq .ID $.ActiveChat.ID}}active{{end}}" data-conversation-id="{{.ID}}">
                    <div class="conversation-avatar">
                        <img src="{{.Avatar}}" alt="{{.Name}}" />
                        {{if .IsOnline}}
                        <div class="online-indicator"></div>
                        {{end}}
                    </div>
                    <div class="conversation-info">
                        <div class="conversation-header">
                            <h3 class="conversation-name">{{.Name}}</h3>
                            <span class="conversation-time">{{.LastTime}}</span>
                        </div>
                        <div class="conversation-preview">
                            <p class="last-message">{{.LastMessage}}</p>
                            {{if .UnreadCount}}
                            <span class="unread-count">{{.UnreadCount}}</span>
                            {{end}}
                        </div>
                        {{if .IsGroup}}
                        <div class="group-indicator">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256">
                                <path d="M117.25,157.92a60,60,0,1,0-66.5,0A95.83,95.83,0,0,0,3.53,195.63a8,8,0,1,0,13.4,8.74,80,80,0,0,1,134.14,0,8,8,0,0,0,13.4-8.74A95.83,95.83,0,0,0,117.25,157.92ZM40,108a44,44,0,1,1,44,44A44.05,44.05,0,0,1,40,108Zm210.27,98.63a8,8,0,0,1-11.29.74A80,80,0,0,0,172,168a8,8,0,0,1,0-16,44,44,0,1,0-16.34-84.87,8,8,0,1,1-5.94-14.85,60,60,0,0,1,55.53,105.64,95.83,95.83,0,0,1,47.22,37.71A8,8,0,0,1,250.27,206.63Z"></path>
                            </svg>
                        </div>
                        {{end}}
                    </div>
                </div>
                {{end}}
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="chat-main" id="chat-main">
            {{if .ActiveChat}}
            <div class="chat-header">
                <div class="chat-user-info">
                    <div class="chat-avatar">
                        <img src="{{.ActiveChat.Avatar}}" alt="{{.ActiveChat.Name}}" />
                        {{if .ActiveChat.IsOnline}}
                        <div class="online-indicator"></div>
                        {{end}}
                    </div>
                    <div class="chat-details">
                        <h2 class="chat-name">{{.ActiveChat.Name}}</h2>
                        {{if .ActiveChat.IsGroup}}
                        <p class="chat-participants">
                            {{range $index, $participant := .ActiveChat.Participants}}{{if $index}}, {{end}}{{$participant.Name}}{{end}}
                        </p>
                        {{else}}
                        <p class="chat-status">
                            {{if .ActiveChat.IsOnline}}Online now{{else}}Last seen 2h ago{{end}}
                        </p>
                        {{end}}
                    </div>
                </div>
                <div class="chat-actions">
                    <button class="chat-action-btn" hx-post="/chat/{{.ActiveChat.ID}}/call/voice" hx-target="#modal" aria-label="Start voice call">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256">
                            <path d="M222.37,158.46l-47.11-21.11-.13-.06a16,16,0,0,0-15.17,1.4,8.12,8.12,0,0,0-.75.56L134.87,160c-15.42-7.49-31.34-23.29-38.83-38.51l20.78-24.71c.2-.25.39-.5.57-.77a16,16,0,0,0,1.32-15.06l0-.12L97.54,33.64a16,16,0,0,0-16.62-9.52A56.26,56.26,0,0,0,32,80c0,79.4,64.6,144,144,144a56.26,56.26,0,0,0,55.88-48.92A16,16,0,0,0,222.37,158.46ZM176,208A128.14,128.14,0,0,1,48,80,40.2,40.2,0,0,1,82.87,40a.61.61,0,0,0,0,.12l21,47L83.2,111.86a6.13,6.13,0,0,0-.57.77,16,16,0,0,0-1,15.7c9.06,18.53,27.73,37.06,46.46,46.11a16,16,0,0,0,15.75-1.14,8.44,8.44,0,0,0,.74-.56L168.89,152l47,21.05h0s.08,0,.11,0A40.21,40.21,0,0,1,176,208Z"></path>
                        </svg>
                    </button>
                    <button class="chat-action-btn" hx-post="/chat/{{.ActiveChat.ID}}/call/video" hx-target="#modal" aria-label="Start video call">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256">
                            <path d="M251.77,73a8,8,0,0,0-8.21.39L208,97.05V72a16,16,0,0,0-16-16H32A16,16,0,0,0,16,72V184a16,16,0,0,0,16,16H192a16,16,0,0,0,16-16V159l35.56,23.71A8,8,0,0,0,248,184a8,8,0,0,0,8-8V80A8,8,0,0,0,251.77,73ZM192,184H32V72H192V184Zm48-22.95L208,138.95v21.1L240,183.05Z"></path>
                        </svg>
                    </button>
                    <button class="chat-action-btn menu-btn" aria-label="More options">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256">
                            <path d="M144,128a16,16,0,1,1-16-16A16,16,0,0,1,144,128ZM60,112a16,16,0,1,0,16,16A16,16,0,0,0,60,112Zm136,0a16,16,0,1,0,16,16A16,16,0,0,0,196,112Z"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="messages-container">
                <div class="messages-list">
                    {{range .Messages}}
                    <div class="message {{if .IsOwn}}own{{else}}other{{end}}" data-message-id="{{.ID}}">
                        {{if not .IsOwn}}
                        <div class="message-avatar">
                            <img src="{{.Sender.Avatar}}" alt="{{.Sender.Name}}" />
                        </div>
                        {{end}}
                        <div class="message-content">
                            {{if not .IsOwn}}
                            <div class="message-sender">{{.Sender.Name}}</div>
                            {{end}}
                            {{if eq .Type "text"}}
                            <div class="message-bubble">
                                <p>{{.Content}}</p>
                            </div>
                            {{else if eq .Type "image"}}
                            <div class="message-media">
                                <img src="{{.Media.URL}}" alt="{{.Media.Alt}}" loading="lazy" />
                                {{if .Content}}
                                <div class="message-bubble">
                                    <p>{{.Content}}</p>
                                </div>
                                {{end}}
                            </div>
                            {{end}}
                            <div class="message-meta">
                                <span class="message-time">{{.Timestamp}}</span>
                                {{if .IsOwn}}
                                <div class="message-status">
                                    {{if .IsRead}}
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256" class="read-receipt">
                                        <path d="M173.66,98.34a8,8,0,0,1,0,11.32l-56,56a8,8,0,0,1-11.32,0l-24-24a8,8,0,0,1,11.32-11.32L112,148.69l50.34-50.35A8,8,0,0,1,173.66,98.34Z"></path>
                                    </svg>
                                    {{else}}
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256" class="delivered">
                                        <path d="M228.24,76.24l-128,128a8,8,0,0,1-11.31,0L48,163.31A8,8,0,0,1,59.31,152l34.35,34.34,122.34-122.35a8,8,0,0,1,11.32,11.32Z"></path>
                                    </svg>
                                    {{end}}
                                </div>
                                {{end}}
                            </div>
                        </div>
                    </div>
                    {{end}}
                </div>

                <!-- Typing indicator -->
                <div class="typing-indicator" id="typing-indicator" style="display: none;">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    <div class="typing-user">Maya is typing</div>
                </div>
            </div>

            <div class="message-compose">
                <div class="compose-actions">
                    <button class="compose-btn attach-btn" aria-label="Attach file">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256">
                            <path d="M209.66,122.34a8,8,0,0,1,0,11.32l-82.05,82a56,56,0,0,1-79.2-79.21L147.67,35.73a40,40,0,1,1,56.61,56.55L105,193A24,24,0,1,1,71,159L154.3,76.7A8,8,0,1,1,165.7,88.3L82.39,171A8,8,0,1,0,93.61,182.3L192.9,81.61a24,24,0,0,0-33.94-33.94L59.76,148.4a40,40,0,0,0,56.53,56.62l82.05-82A8,8,0,0,1,209.66,122.34Z"></path>
                        </svg>
                    </button>
                </div>
                <div class="message-input-container">
                    <textarea class="message-input" 
                              placeholder="Type a message..." 
                              rows="1" 
                              hx-post="/chat/{{.ActiveChat.ID}}/message" 
                              hx-trigger="keydown[ctrlKey&&keyCode==13]"
                              hx-target="#messages-list" 
                              hx-swap="beforeend"></textarea>
                </div>
                <div class="send-actions">
                    <button class="compose-btn emoji-btn" aria-label="Add emoji">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256">
                            <path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216ZM80,108a12,12,0,1,1,12,12A12,12,0,0,1,80,108Zm96,0a12,12,0,1,1-12-12A12,12,0,0,1,176,108Zm-1.07,48c-10.29,17.79-27.39,28-46.93,28s-36.64-10.2-46.93-28a8,8,0,1,1,13.86-8c7.77,13.45,20.41,20,33.07,20s25.3-6.53,33.07-20a8,8,0,0,1,13.86,8Z"></path>
                        </svg>
                    </button>
                    <button class="send-btn" aria-label="Send message">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256"><path d="M227.32,28.68a16,16,0,0,0-15.66-4.08l-.15,0L19.57,82.84a16,16,0,0,0-2.49,29.8L102,154l41.3,84.87A15.86,15.86,0,0,0,157.74,248q.69,0,1.38-.06a15.88,15.88,0,0,0,14-11.51l58.2-191.94c0-.05,0-.1,0-.15A16,16,0,0,0,227.32,28.68ZM157.83,231.85l-.05.14,0-.07-40.06-82.3,48-48a8,8,0,0,0-11.31-11.31l-48,48L24.08,98.25l-.07,0,.14,0L216,40Z"></path></svg>
                    </button>
                </div>
            </div>
            {{else}}
            <div class="no-chat-selected">
                <div class="no-chat-content">
                    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" viewBox="0 0 256 256" class="no-chat-icon">
                        <path d="M216,48H40A16,16,0,0,0,24,64V224a15.84,15.84,0,0,0,9.25,14.5A16.13,16.13,0,0,0,40,240a15.89,15.89,0,0,0,10.25-3.78L69.56,224H216a16,16,0,0,0,16-16V64A16,16,0,0,0,216,48ZM216,208H64L40,224V64H216Z"></path>
                    </svg>
                    <h3>Select a conversation</h3>
                    <p>Choose from your existing conversations or start a new one</p>
                    <button class="btn-primary start-chat-btn" hx-get="/chat/new" hx-target="#modal">
                        Start New Chat
                    </button>
                </div>
            </div>
            {{end}}
        </main>
    </div>
</div>

<!-- Modal container for HTMX -->
<div id="modal" hx-swap-oob="true"></div>
{{end}}

{{define "scripts"}}
<script>
// Chat functionality
document.addEventListener('DOMContentLoaded', function() {
    const messageInput = document.querySelector('.message-input');
    const conversationItems = document.querySelectorAll('.conversation-item');
    
    // Auto-resize textarea
    if (messageInput) {
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
        
        // Send message on Ctrl+Enter
        messageInput.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                const sendBtn = document.querySelector('.send-btn');
                if (sendBtn) sendBtn.click();
            }
        });
    }
    
    // Conversation selection
    conversationItems.forEach(item => {
        item.addEventListener('click', function() {
            conversationItems.forEach(i => i.classList.remove('active'));
            this.classList.add('active');
        });
    });
    
    // Scroll to bottom of messages
    const messagesList = document.querySelector('.messages-list');
    if (messagesList) {
        messagesList.scrollTop = messagesList.scrollHeight;
    }
    
    // Mock typing indicator (for demo purposes)
    setTimeout(() => {
        const typingIndicator = document.querySelector('#typing-indicator');
        if (typingIndicator) {
            typingIndicator.style.display = 'flex';
            setTimeout(() => {
                typingIndicator.style.display = 'none';
            }, 3000);
        }
    }, 2000);
});

// HTMX event listeners
document.body.addEventListener('htmx:afterSwap', function(evt) {
    // Scroll to bottom after new messages
    if (evt.detail.target.classList.contains('messages-list')) {
        evt.detail.target.scrollTop = evt.detail.target.scrollHeight;
    }
    
    // Clear input after sending message
    if (evt.detail.target.id === 'messages-list') {
        const messageInput = document.querySelector('.message-input');
        if (messageInput) {
            messageInput.value = '';
            messageInput.style.height = 'auto';
        }
    }
});

document.body.addEventListener('htmx:responseError', function(evt) {
    console.error('HTMX Error:', evt.detail.xhr.responseText);
});
</script>
{{end}}